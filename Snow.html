<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snow</title>
    <script src="js/CCapture.min.js"></script>
    <script src="js/webm-writer-0.2.0.js"></script>
    <script src="js/gif.js"></script>
    <script src="js/tar.js"></script>
    <script src="js/download.js"></script>
    <link rel="stylesheet" href="./snowstyle.css" />
  </head>
  <body>
    <div id="snow" count="200"></div>
    <script src="Stats.min.js"></script>
    <script src="pixi.min.js"></script>
    <script src="./snowscript.js"></script>
    <script>
      const animationElement = document.getElementById("animationElement");
      const recordedVideo = document.getElementById("recordedVideo");

      // 녹화 시작 시간과 녹화 지속 시간 설정 (단위: 밀리초)
      const recordingStartTime = 1000; // 1초 후에 녹화 시작
      const recordingDuration = 5000; // 5초 동안 녹화

      let mediaRecorder;
      let recordedChunks = [];
      let animationStartTime;

      function animate(timestamp) {
        if (!animationStartTime) {
          animationStartTime = timestamp;
        }

        const elapsedTime = timestamp - animationStartTime;

        if (
          elapsedTime >= recordingStartTime &&
          elapsedTime < recordingStartTime + recordingDuration
        ) {
          animationElement.style.opacity = "0"; // 예시로 투명도를 조정하여 페이드 아웃 애니메이션을 만듭니다.
        } else {
          animationElement.style.opacity = "1"; // 애니메이션 종료 후 초기 상태로 복원합니다.
        }

        if (elapsedTime < recordingStartTime + recordingDuration) {
          requestAnimationFrame(animate);
        } else {
          stopRecording();
        }
      }

      function startRecording() {
        recordedChunks = [];
        const stream = animationElement.captureStream();
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "video/mp4" });
          const url = URL.createObjectURL(blob);

          recordedVideo.src = url;
          recordedVideo.controls = true;

          // 생성된 mp4 파일의 링크를 백엔드에 보내줍니다.
          sendToBackend(url);
        };

        mediaRecorder.start();
        animationStartTime = null;
        animate(performance.now());
      }

      function stopRecording() {
        mediaRecorder.stop();
      }

      function sendToBackend(url) {
        // 여기서는 백엔드로 AJAX 요청을 보내거나, fetch API를 사용하여 파일을 업로드하는 방식으로 보내줍니다.
        // 백엔드에서는 해당 URL을 다운로드하거나 저장하는 작업을 수행할 수 있습니다.
        console.log("URL to send:", url);
      }

      // 녹화를 자동으로 시작합니다.
      setTimeout(startRecording, recordingStartTime);
    </script>
  </body>
</html>
